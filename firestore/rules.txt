rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    function signedIn() {
      return request.auth != null;
    }

    function isOwner(companyId) {
      return signedIn() && request.auth.uid == companyId;
    }

    function hasRole(role) {
      return signedIn()
        && exists(/databases/$(database)/documents/users/$(request.auth.uid))
        && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == role;
    }

    function isAdmin() {
      return hasRole("admin");
    }

    function companyAutoConfirmEnabled(companyId) {
      return exists(/databases/$(database)/documents/companies_public/$(companyId))
        && get(/databases/$(database)/documents/companies_public/$(companyId)).data.bookingAutoConfirm == true;
    }

    function companyOwnerCannotChangeBadge() {
      return !request.resource.data.diff(resource.data).affectedKeys().hasAny(["badge"]);
    }

    function servicePhotosAreValid() {
      return !("photoUrls" in request.resource.data)
        || (request.resource.data.photoUrls is list && request.resource.data.photoUrls.size() <= 3);
    }

    match /users/{uid} {
      allow read, write: if signedIn() && request.auth.uid == uid;
    }

    match /companies_public/{companyId} {
      allow read: if true;
      allow create: if isOwner(companyId) || isAdmin();
      allow update: if isAdmin() || (isOwner(companyId) && companyOwnerCannotChangeBadge());
      allow delete: if isAdmin();

      match /services_public/{serviceId} {
        allow read: if true;
        allow create, update: if (isOwner(companyId) || isAdmin()) && servicePhotosAreValid();
        allow delete: if isOwner(companyId) || isAdmin();

        match /ratings/{uid} {
          allow read: if true;
          allow create, update, delete: if signedIn()
            && request.auth.uid == uid
            && hasRole("customer");
        }
      }

      match /followers/{followerId} {
        allow read: if true;
        allow create, update: if signedIn()
          && request.auth.uid == followerId
          && request.resource.data.userId == request.auth.uid;
        allow delete: if signedIn() && request.auth.uid == followerId;
      }

      match /ratings/{uid} {
        allow read: if true;
        allow create, update, delete: if signedIn()
          && request.auth.uid == uid
          && hasRole("customer");
      }
    }

    match /companies/{companyId} {
      allow read, create, update: if isOwner(companyId) || isAdmin();
      allow delete: if isAdmin();

      match /booking_blocks/{blockId} {
        allow read: if true;
        allow create, update, delete: if isOwner(companyId) || isAdmin();
      }

      match /notifications/{notificationId} {
        allow read: if isOwner(companyId) || isAdmin();
        allow create: if signedIn()
          && request.resource.data.companyId == companyId
          && request.resource.data.actorId == request.auth.uid
          && request.resource.data.read == false;
        allow update, delete: if isOwner(companyId) || isAdmin();
      }
    }

    match /bookings/{bookingId} {
      allow read: if signedIn()
        && (isAdmin() || resource.data.customerId == request.auth.uid || resource.data.companyId == request.auth.uid);

      allow create: if signedIn()
        && hasRole("customer")
        && request.resource.data.customerId == request.auth.uid
        && (
          request.resource.data.status == "pending"
          || (
            request.resource.data.status == "confirmed"
            && companyAutoConfirmEnabled(request.resource.data.companyId)
          )
        );

      allow update: if signedIn()
        && (
          isAdmin()
          || (
            request.resource.data.diff(resource.data).affectedKeys().hasOnly(["status", "updatedAt"])
            && (
              (
                request.auth.uid == resource.data.companyId
                && resource.data.status == "pending"
                && (request.resource.data.status == "confirmed" || request.resource.data.status == "declined")
              )
              || (
                request.auth.uid == resource.data.customerId
                && (resource.data.status == "pending" || resource.data.status == "confirmed")
                && request.resource.data.status == "cancelled_by_customer"
              )
            )
          )
        );

      allow delete: if isAdmin();
    }

    match /booking_slot_locks/{lockId} {
      allow read: if signedIn();
      allow create: if signedIn()
        && hasRole("customer")
        && request.resource.data.userId == request.auth.uid;
      allow update: if false;
      allow delete: if signedIn()
        && (
          isAdmin()
          || request.auth.uid == resource.data.userId
          || request.auth.uid == resource.data.companyId
        );
    }

    match /feed_public/{postId} {
      allow read: if true;

      allow create: if signedIn() && request.resource.data.companyId == request.auth.uid;

      allow update: if signedIn()
        && resource.data.companyId == request.auth.uid
        && request.resource.data.companyId == request.auth.uid;

      allow delete: if signedIn() && resource.data.companyId == request.auth.uid;

      match /likes/{uid} {
        allow read: if true;
        allow create, update: if signedIn()
          && request.auth.uid == uid
          && request.resource.data.userId == request.auth.uid;
        allow delete: if signedIn() && request.auth.uid == uid;
      }

      match /comments/{commentId} {
        allow read: if true;
        allow create: if signedIn()
          && request.resource.data.userId == request.auth.uid;
        allow update: if false;
        allow delete: if signedIn() && resource.data.userId == request.auth.uid;

        match /likes/{uid} {
          allow read: if true;
          allow create, update: if signedIn()
            && request.auth.uid == uid
            && request.resource.data.userId == request.auth.uid;
          allow delete: if signedIn() && request.auth.uid == uid;
        }
      }
    }
  }
}
