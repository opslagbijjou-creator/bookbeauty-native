rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    function signedIn() {
      return request.auth != null;
    }

    function isOwner(companyId) {
      return signedIn() && request.auth.uid == companyId;
    }

    function hasRole(role) {
      return signedIn()
        && exists(/databases/$(database)/documents/users/$(request.auth.uid))
        && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == role;
    }

    function isEmployeeOf(companyId) {
      return hasRole("employee")
        && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.companyId == companyId;
    }

    function isAdmin() {
      return hasRole("admin");
    }

    function canActAsCustomer() {
      return signedIn()
        && (
          !exists(/databases/$(database)/documents/users/$(request.auth.uid))
          || get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == "customer"
        );
    }

    function canCreateBookingActor() {
      return signedIn()
        && (
          !exists(/databases/$(database)/documents/users/$(request.auth.uid))
          || get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == "customer"
          || get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == "company"
        );
    }

    function companyAutoConfirmEnabled(companyId) {
      return exists(/databases/$(database)/documents/companies_public/$(companyId))
        && get(/databases/$(database)/documents/companies_public/$(companyId)).data.bookingAutoConfirm == true;
    }

    function companyOwnerCannotChangeBadge() {
      return !request.resource.data.diff(resource.data).affectedKeys().hasAny(["badge"]);
    }

    function servicePhotosAreValid() {
      return !("photoUrls" in request.resource.data)
        || (request.resource.data.photoUrls is list && request.resource.data.photoUrls.size() <= 3);
    }

    function ownerCanAssignEmployee(uid) {
      return hasRole("company")
        && request.auth.uid != uid
        && exists(/databases/$(database)/documents/users/$(uid))
        && get(/databases/$(database)/documents/users/$(uid)).data.role == "customer"
        && request.resource.data.role == "employee"
        && request.resource.data.companyId == request.auth.uid
        && request.resource.data.email == get(/databases/$(database)/documents/users/$(uid)).data.email
        && request.resource.data.diff(resource.data).affectedKeys().hasOnly(["role", "companyId", "updatedAt"]);
    }

    function ownerCanUnassignEmployee(uid) {
      return hasRole("company")
        && request.auth.uid != uid
        && exists(/databases/$(database)/documents/users/$(uid))
        && get(/databases/$(database)/documents/users/$(uid)).data.role == "employee"
        && get(/databases/$(database)/documents/users/$(uid)).data.companyId == request.auth.uid
        && request.resource.data.role == "customer"
        && request.resource.data.email == get(/databases/$(database)/documents/users/$(uid)).data.email
        && (!("companyId" in request.resource.data) || request.resource.data.companyId == "")
        && request.resource.data.diff(resource.data).affectedKeys().hasOnly(["role", "companyId", "updatedAt"]);
    }

    match /users/{uid} {
      allow read: if signedIn() && (request.auth.uid == uid || isAdmin());
      allow create: if signedIn()
        && request.auth.uid == uid
        && request.resource.data.email is string
        && (request.resource.data.role == "customer" || request.resource.data.role == "company");
      allow update: if signedIn() && (
        isAdmin()
        || ownerCanAssignEmployee(uid)
        || ownerCanUnassignEmployee(uid)
        || (request.auth.uid == uid
          && !request.resource.data.diff(resource.data).affectedKeys().hasAny(["role", "companyId"]))
      );
      allow delete: if isAdmin();
    }

    match /user_lookup/{emailKey} {
      allow read: if signedIn() && (isAdmin() || hasRole("company"));
      allow create, update: if signedIn() && request.auth.uid == request.resource.data.uid;
      allow delete: if isAdmin();
    }

    match /companies_public/{companyId} {
      allow read: if true;
      allow create: if isOwner(companyId) || isAdmin();
      allow update: if isAdmin() || (isOwner(companyId) && companyOwnerCannotChangeBadge());
      allow delete: if isAdmin();

      match /services_public/{serviceId} {
        allow read: if true;
        allow create, update: if (isOwner(companyId) || isAdmin()) && servicePhotosAreValid();
        allow delete: if isOwner(companyId) || isAdmin();

        match /ratings/{uid} {
          allow read: if true;
          allow create, update, delete: if signedIn()
            && request.auth.uid == uid
            && canActAsCustomer();
        }
      }

      match /followers/{followerId} {
        allow read: if true;
        allow create, update: if signedIn()
          && request.auth.uid == followerId
          && request.resource.data.userId == request.auth.uid;
        allow delete: if signedIn() && request.auth.uid == followerId;
      }

      match /staff_public/{staffId} {
        allow read: if true;
        allow create, update, delete: if isOwner(companyId) || isAdmin();
      }

      match /ratings/{uid} {
        allow read: if true;
        allow create, update, delete: if signedIn()
          && request.auth.uid == uid
          && canActAsCustomer();
      }
    }

    match /companies/{companyId} {
      allow read: if isOwner(companyId) || isEmployeeOf(companyId) || isAdmin();
      allow create, update: if isOwner(companyId) || isAdmin();
      allow delete: if isAdmin();

      match /booking_blocks/{blockId} {
        allow read: if true;
        allow create, update, delete: if isOwner(companyId) || isAdmin();
      }

      match /staff/{staffId} {
        allow read: if isOwner(companyId) || isAdmin() || (isEmployeeOf(companyId) && request.auth.uid == staffId);
        allow create, update, delete: if isOwner(companyId) || isAdmin();
      }

      match /notifications/{notificationId} {
        allow read: if isOwner(companyId) || isAdmin();
        allow create: if signedIn()
          && request.resource.data.companyId == companyId
          && request.resource.data.actorId == request.auth.uid
          && request.resource.data.read == false;
        allow update, delete: if isOwner(companyId) || isAdmin();
      }
    }

    match /bookings/{bookingId} {
      allow read: if signedIn()
        && (
          isAdmin()
          || resource.data.customerId == request.auth.uid
          || resource.data.companyId == request.auth.uid
          || resource.data.staffId == request.auth.uid
        );

      allow create: if signedIn()
        && canCreateBookingActor()
        && request.resource.data.customerId == request.auth.uid
        && request.resource.data.companyId is string
        && request.resource.data.serviceId is string
        && request.resource.data.staffId is string
        && (
          request.resource.data.status == "pending"
          || (
            request.resource.data.status == "confirmed"
            && companyAutoConfirmEnabled(request.resource.data.companyId)
          )
        );

      allow update: if signedIn()
        && (
          isAdmin()
          || (
            request.resource.data.companyId == resource.data.companyId
            && request.resource.data.customerId == resource.data.customerId
            && request.resource.data.serviceId == resource.data.serviceId
            && request.resource.data.staffId == resource.data.staffId
            && (
              request.auth.uid == resource.data.companyId
              || request.auth.uid == resource.data.customerId
              || request.auth.uid == resource.data.staffId
            )
          )
        );

      allow delete: if isAdmin();
    }

    match /booking_slot_locks/{lockId} {
      allow read: if signedIn();
      allow create: if signedIn()
        && (
          isAdmin()
          || request.auth.uid == request.resource.data.companyId
          || (
            hasRole("employee")
            && request.resource.data.staffId == request.auth.uid
            && request.resource.data.companyId == get(/databases/$(database)/documents/users/$(request.auth.uid)).data.companyId
          )
          || (
            canCreateBookingActor()
            && request.resource.data.userId == request.auth.uid
          )
        );
      allow update: if false;
      allow delete: if signedIn()
        && (
          isAdmin()
          || request.auth.uid == resource.data.userId
          || request.auth.uid == resource.data.companyId
          || request.auth.uid == resource.data.staffId
        );
    }

    match /feed_public/{postId} {
      allow read: if true;

      allow create: if signedIn() && request.resource.data.companyId == request.auth.uid;

      allow update: if signedIn()
        && resource.data.companyId == request.auth.uid
        && request.resource.data.companyId == request.auth.uid;

      allow delete: if signedIn() && resource.data.companyId == request.auth.uid;

      match /likes/{uid} {
        allow read: if true;
        allow create, update: if signedIn()
          && request.auth.uid == uid
          && request.resource.data.userId == request.auth.uid;
        allow delete: if signedIn() && request.auth.uid == uid;
      }

      match /comments/{commentId} {
        allow read: if true;
        allow create: if signedIn()
          && request.resource.data.userId == request.auth.uid;
        allow update: if false;
        allow delete: if signedIn() && resource.data.userId == request.auth.uid;

        match /likes/{uid} {
          allow read: if true;
          allow create, update: if signedIn()
            && request.auth.uid == uid
            && request.resource.data.userId == request.auth.uid;
          allow delete: if signedIn() && request.auth.uid == uid;
        }
      }
    }
  }
}
